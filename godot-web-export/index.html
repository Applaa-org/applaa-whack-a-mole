<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Whack-a-Mole (Animal Edition)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard', cursive, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #90EE90 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
        }

        /* Start Screen */
        .start-screen {
            background: linear-gradient(145deg, #FFE4B5, #FFDAB9);
            border-radius: 30px;
            padding: 40px 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2), inset 0 2px 10px rgba(255,255,255,0.5);
            border: 5px solid #DEB887;
        }

        .game-title {
            font-size: 2.5em;
            color: #8B4513;
            text-shadow: 3px 3px 0 #FFD700, 5px 5px 10px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .game-subtitle {
            font-size: 1.2em;
            color: #A0522D;
            margin-bottom: 25px;
        }

        .instructions {
            background: rgba(255,255,255,0.7);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 25px;
            color: #6B4423;
            font-size: 1em;
            line-height: 1.6;
        }

        .high-score-display {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: #8B4513;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .high-score-display .trophy {
            font-size: 1.5em;
            margin-right: 8px;
        }

        .leaderboard {
            background: rgba(255,255,255,0.8);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }

        .leaderboard h3 {
            color: #8B4513;
            margin-bottom: 10px;
            text-align: center;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px dashed #DEB887;
            color: #6B4423;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item .rank {
            font-weight: bold;
            color: #8B4513;
        }

        .player-name-section {
            margin-bottom: 20px;
        }

        .player-name-section label {
            display: block;
            color: #8B4513;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .player-name-input {
            width: 80%;
            padding: 12px 15px;
            font-size: 1.1em;
            border: 3px solid #DEB887;
            border-radius: 15px;
            font-family: inherit;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }

        .player-name-input:focus {
            border-color: #8B4513;
        }

        .btn {
            padding: 18px 50px;
            font-size: 1.4em;
            font-family: inherit;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-start {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 8px 0 #2E7D32, 0 12px 20px rgba(0,0,0,0.3);
        }

        .btn-start:hover {
            transform: translateY(-3px);
            box-shadow: 0 11px 0 #2E7D32, 0 15px 25px rgba(0,0,0,0.3);
        }

        .btn-start:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #2E7D32, 0 6px 10px rgba(0,0,0,0.3);
        }

        .btn-close {
            background: linear-gradient(145deg, #f44336, #d32f2f);
            color: white;
            box-shadow: 0 6px 0 #b71c1c, 0 10px 15px rgba(0,0,0,0.3);
            padding: 12px 30px;
            font-size: 1em;
            margin-top: 15px;
        }

        .btn-close:hover {
            transform: translateY(-2px);
        }

        .btn-close:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #b71c1c;
        }

        /* Game Screen */
        .game-screen {
            display: none;
        }

        .game-hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(145deg, #FFE4B5, #FFDAB9);
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .hud-item {
            text-align: center;
        }

        .hud-label {
            font-size: 0.9em;
            color: #A0522D;
            margin-bottom: 5px;
        }

        .hud-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #8B4513;
        }

        .hud-value.timer {
            color: #D2691E;
        }

        .hud-value.timer.warning {
            color: #FF4500;
            animation: pulse 0.5s ease-in-out infinite;
        }

        .hud-high-score {
            font-size: 0.85em;
            color: #CD853F;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .game-board {
            background: linear-gradient(180deg, #8B4513 0%, #654321 100%);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4), inset 0 5px 20px rgba(0,0,0,0.3);
            border: 6px solid #5D3A1A;
        }

        .holes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .hole {
            position: relative;
            aspect-ratio: 1;
            cursor: pointer;
        }

        .hole-bg {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 45%;
            background: radial-gradient(ellipse at center, #2C1810 0%, #1a0f0a 100%);
            border-radius: 50%;
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.8);
        }

        .hole-front {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 25%;
            background: linear-gradient(180deg, #654321 0%, #8B4513 100%);
            border-radius: 50%;
            z-index: 10;
        }

        .animal {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            font-size: 3.5em;
            transition: transform 0.15s ease-out;
            z-index: 5;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4));
        }

        .animal.visible {
            transform: translateX(-50%) translateY(0);
        }

        .animal.hit {
            animation: hitEffect 0.3s ease-out;
        }

        @keyframes hitEffect {
            0% { transform: translateX(-50%) translateY(0) scale(1); }
            30% { transform: translateX(-50%) translateY(-20px) scale(1.3) rotate(15deg); }
            100% { transform: translateX(-50%) translateY(100%) scale(0.5); opacity: 0; }
        }

        .score-popup {
            position: absolute;
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            pointer-events: none;
            animation: scoreFloat 0.8s ease-out forwards;
            z-index: 20;
        }

        @keyframes scoreFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.5); }
        }

        /* Game Over Screen */
        .game-over-screen {
            display: none;
            background: linear-gradient(145deg, #FFE4B5, #FFDAB9);
            border-radius: 30px;
            padding: 40px 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2), inset 0 2px 10px rgba(255,255,255,0.5);
            border: 5px solid #DEB887;
        }

        .game-over-title {
            font-size: 2.2em;
            color: #8B4513;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #FFD700;
        }

        .final-score-section {
            background: linear-gradient(145deg, #87CEEB, #ADD8E6);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .final-score-label {
            font-size: 1.2em;
            color: #4682B4;
            margin-bottom: 10px;
        }

        .final-score-value {
            font-size: 3.5em;
            font-weight: bold;
            color: #1E90FF;
            text-shadow: 3px 3px 0 rgba(255,255,255,0.5);
        }

        .new-high-score {
            display: none;
            background: linear-gradient(145deg, #FFD700, #FFA500);
            color: #8B4513;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: bold;
            animation: celebrate 0.5s ease-in-out infinite;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(-2deg); }
            50% { transform: scale(1.05) rotate(2deg); }
        }

        .game-over-high-score {
            background: rgba(255,255,255,0.7);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: #8B4513;
            font-size: 1.1em;
        }

        .btn-restart {
            background: linear-gradient(145deg, #FF9800, #F57C00);
            color: white;
            box-shadow: 0 8px 0 #E65100, 0 12px 20px rgba(0,0,0,0.3);
            margin-right: 10px;
        }

        .btn-restart:hover {
            transform: translateY(-3px);
            box-shadow: 0 11px 0 #E65100, 0 15px 25px rgba(0,0,0,0.3);
        }

        .btn-restart:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #E65100;
        }

        .btn-menu {
            background: linear-gradient(145deg, #9C27B0, #7B1FA2);
            color: white;
            box-shadow: 0 6px 0 #4A148C, 0 10px 15px rgba(0,0,0,0.3);
            padding: 12px 30px;
            font-size: 1em;
            margin-top: 15px;
        }

        .btn-menu:hover {
            transform: translateY(-2px);
        }

        .btn-menu:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #4A148C;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        /* Animals decorations */
        .animals-decoration {
            font-size: 2em;
            margin: 15px 0;
        }

        /* Responsive */
        @media (max-width: 400px) {
            .game-title {
                font-size: 2em;
            }
            .animal {
                font-size: 2.8em;
            }
            .holes-grid {
                gap: 10px;
            }
            .game-board {
                padding: 15px;
            }
            .btn {
                padding: 15px 40px;
                font-size: 1.2em;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Start Screen -->
        <div class="start-screen" id="startScreen">
            <h1 class="game-title">üî® Whack-a-Mole</h1>
            <p class="game-subtitle">üêæ Animal Edition üêæ</p>
            
            <div class="animals-decoration">üê∂ üê± üê∞ üêπ ü¶ä üêª</div>
            
            <div class="instructions">
                <p>üéØ Tap the cute animals as they pop up!</p>
                <p>‚è±Ô∏è Score as many points as you can in 30 seconds!</p>
                <p>üåü Different animals = different points!</p>
            </div>

            <div class="high-score-display" id="startHighScore">
                <span class="trophy">üèÜ</span>
                <span>High Score: <span id="displayHighScore">0</span></span>
            </div>

            <div class="leaderboard" id="leaderboard" style="display: none;">
                <h3>üèÖ Top Scores</h3>
                <div id="leaderboardList"></div>
            </div>

            <div class="player-name-section">
                <label for="playerNameInput">Your Name:</label>
                <input type="text" id="playerNameInput" class="player-name-input" placeholder="Enter name..." maxlength="15">
            </div>

            <button class="btn btn-start" id="startBtn">Start Game</button>
            <br>
            <button class="btn btn-close" id="closeBtn">Close</button>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <div class="game-hud">
                <div class="hud-item">
                    <div class="hud-label">Score</div>
                    <div class="hud-value" id="scoreDisplay">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Time</div>
                    <div class="hud-value timer" id="timerDisplay">30</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Best</div>
                    <div class="hud-value hud-high-score" id="hudHighScore">0</div>
                </div>
            </div>

            <div class="game-board">
                <div class="holes-grid" id="holesGrid">
                    <!-- Holes will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div class="game-over-screen" id="gameOverScreen">
            <h2 class="game-over-title">‚è∞ Time's Up!</h2>
            
            <div class="animals-decoration">üéâ üêæ üåü üêæ üéâ</div>

            <div class="final-score-section">
                <div class="final-score-label">Your Score</div>
                <div class="final-score-value" id="finalScore">0</div>
            </div>

            <div class="new-high-score" id="newHighScore">
                üéä New High Score! üéä
            </div>

            <div class="game-over-high-score">
                <span>üèÜ High Score: <span id="gameOverHighScore">0</span></span>
            </div>

            <div class="button-group">
                <button class="btn btn-restart" id="restartBtn">Play Again</button>
                <button class="btn btn-menu" id="menuBtn">Main Menu</button>
                <button class="btn btn-close" id="closeBtn2">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Game Configuration
        const GAME_CONFIG = {
            gameDuration: 30,
            minPopInterval: 800,
            maxPopInterval: 1200,
            animalVisibleTime: 700,
            holes: 9
        };

        // Animals with their points and emojis
        const ANIMALS = [
            { emoji: 'üê∂', name: 'Dog', points: 10 },
            { emoji: 'üê±', name: 'Cat', points: 10 },
            { emoji: 'üê∞', name: 'Rabbit', points: 15 },
            { emoji: 'üêπ', name: 'Hamster', points: 15 },
            { emoji: 'ü¶ä', name: 'Fox', points: 20 },
            { emoji: 'üêª', name: 'Bear', points: 25 },
            { emoji: 'üêº', name: 'Panda', points: 30 },
            { emoji: 'ü¶Å', name: 'Lion', points: 35 },
            { emoji: 'üêØ', name: 'Tiger', points: 40 }
        ];

        // Game State
        let gameState = {
            score: 0,
            timeLeft: GAME_CONFIG.gameDuration,
            isPlaying: false,
            currentAnimalHole: null,
            highScore: 0,
            playerName: '',
            scores: []
        };

        // Timers
        let gameTimer = null;
        let popTimer = null;
        let hideTimer = null;

        // Audio Context for sounds
        let audioContext = null;

        // DOM Elements
        const startScreen = document.getElementById('startScreen');
        const gameScreen = document.getElementById('gameScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const holesGrid = document.getElementById('holesGrid');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const finalScore = document.getElementById('finalScore');
        const playerNameInput = document.getElementById('playerNameInput');
        const displayHighScore = document.getElementById('displayHighScore');
        const hudHighScore = document.getElementById('hudHighScore');
        const gameOverHighScore = document.getElementById('gameOverHighScore');
        const newHighScoreEl = document.getElementById('newHighScore');
        const leaderboard = document.getElementById('leaderboard');
        const leaderboardList = document.getElementById('leaderboardList');

        // Initialize game
        function init() {
            createHoles();
            loadGameData();
            setupEventListeners();
        }

        // Create hole elements
        function createHoles() {
            holesGrid.innerHTML = '';
            for (let i = 0; i < GAME_CONFIG.holes; i++) {
                const hole = document.createElement('div');
                hole.className = 'hole';
                hole.dataset.index = i;
                hole.innerHTML = `
                    <div class="animal" id="animal-${i}"></div>
                    <div class="hole-bg"></div>
                    <div class="hole-front"></div>
                `;
                hole.addEventListener('click', handleHoleClick);
                hole.addEventListener('touchstart', handleHoleClick, { passive: true });
                holesGrid.appendChild(hole);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('startBtn').addEventListener('click', startGame);
            document.getElementById('restartBtn').addEventListener('click', restartGame);
            document.getElementById('menuBtn').addEventListener('click', showMainMenu);
            document.getElementById('closeBtn').addEventListener('click', closeGame);
            document.getElementById('closeBtn2').addEventListener('click', closeGame);
        }

        // Load game data from localStorage via Applaa API
        function loadGameData() {
            // Initialize display to 0 first
            displayHighScore.textContent = '0';
            hudHighScore.textContent = '0';
            
            // Get gameId from URL or use default
            const gameId = getGameId();
            
            // Request data from Applaa storage
            window.parent.postMessage({
                type: 'applaa-game-load-data',
                gameId: gameId
            }, '*');

            // Listen for data response
            window.addEventListener('message', handleGameDataLoaded);
        }

        function getGameId() {
            // Try to get gameId from URL params or use default
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('gameId') || 'whack-a-mole-animal-edition';
        }

        function handleGameDataLoaded(event) {
            if (event.data.type === 'applaa-game-data-loaded') {
                const gameData = event.data.data;
                if (gameData) {
                    gameState.highScore = gameData.highScore || 0;
                    gameState.scores = gameData.scores || [];
                    gameState.playerName = gameData.lastPlayerName || '';
                    
                    // Update displays
                    displayHighScore.textContent = gameState.highScore.toLocaleString();
                    hudHighScore.textContent = gameState.highScore.toLocaleString();
                    
                    // Pre-fill player name
                    if (gameState.playerName) {
                        playerNameInput.value = gameState.playerName;
                    }
                    
                    // Display leaderboard
                    displayLeaderboard();
                }
            } else if (event.data.type === 'applaa-game-score-saved') {
                // Score was saved, update local state
                const updatedData = event.data.data;
                if (updatedData) {
                    gameState.highScore = updatedData.highScore || gameState.highScore;
                    gameState.scores = updatedData.scores || gameState.scores;
                    displayHighScore.textContent = gameState.highScore.toLocaleString();
                    displayLeaderboard();
                }
            }
        }

        // Save score to localStorage via Applaa API
        function saveScore(playerName, score) {
            const gameId = getGameId();
            
            window.parent.postMessage({
                type: 'applaa-game-save-score',
                gameId: gameId,
                playerName: playerName || 'Anonymous',
                score: score
            }, '*');
            
            // Update local high score if needed
            if (score > gameState.highScore) {
                gameState.highScore = score;
            }
        }

        // Display leaderboard
        function displayLeaderboard() {
            if (gameState.scores.length === 0) {
                leaderboard.style.display = 'none';
                return;
            }
            
            leaderboard.style.display = 'block';
            leaderboardList.innerHTML = '';
            
            const topScores = gameState.scores.slice(0, 5);
            topScores.forEach((scoreData, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                item.innerHTML = `
                    <span class="rank">${medal}</span>
                    <span>${scoreData.playerName || 'Anonymous'}</span>
                    <span>${scoreData.score.toLocaleString()}</span>
                `;
                leaderboardList.appendChild(item);
            });
        }

        // Initialize Audio Context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Play sound effects
        function playSound(type) {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'pop':
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'hit':
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.05);
                    oscillator.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.15);
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.15);
                    break;
                case 'miss':
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'gameOver':
                    const notes = [523, 392, 330, 262];
                    notes.forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.2);
                        gain.gain.setValueAtTime(0.3, audioContext.currentTime + i * 0.2);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.2 + 0.3);
                        osc.start(audioContext.currentTime + i * 0.2);
                        osc.stop(audioContext.currentTime + i * 0.2 + 0.3);
                    });
                    break;
            }
        }

        // Start Game
        function startGame() {
            initAudio();
            
            // Get player name
            gameState.playerName = playerNameInput.value.trim() || 'Anonymous';
            
            // Reset game state
            gameState.score = 0;
            gameState.timeLeft = GAME_CONFIG.gameDuration;
            gameState.isPlaying = true;
            gameState.currentAnimalHole = null;

            // Update UI
            scoreDisplay.textContent = '0';
            timerDisplay.textContent = gameState.timeLeft;
            timerDisplay.classList.remove('warning');
            hudHighScore.textContent = gameState.highScore.toLocaleString();

            // Clear any existing animals
            clearAllAnimals();

            // Show game screen
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            gameScreen.style.display = 'block';

            // Start game timer
            gameTimer = setInterval(updateTimer, 1000);

            // Start animal pop-up loop
            scheduleNextAnimal();
        }

        // Update timer
        function updateTimer() {
            gameState.timeLeft--;
            timerDisplay.textContent = gameState.timeLeft;

            if (gameState.timeLeft <= 10) {
                timerDisplay.classList.add('warning');
            }

            if (gameState.timeLeft <= 0) {
                endGame();
            }
        }

        // Schedule next animal to appear
        function scheduleNextAnimal() {
            if (!gameState.isPlaying) return;

            const delay = Math.random() * (GAME_CONFIG.maxPopInterval - GAME_CONFIG.minPopInterval) + GAME_CONFIG.minPopInterval;
            
            popTimer = setTimeout(() => {
                if (gameState.isPlaying) {
                    showAnimal();
                }
            }, delay);
        }

        // Show animal in random hole
        function showAnimal() {
            if (!gameState.isPlaying) return;

            // Clear any existing animal first
            clearAllAnimals();

            // Pick random hole (different from last one if possible)
            let holeIndex;
            do {
                holeIndex = Math.floor(Math.random() * GAME_CONFIG.holes);
            } while (holeIndex === gameState.currentAnimalHole && GAME_CONFIG.holes > 1);

            gameState.currentAnimalHole = holeIndex;

            // Pick random animal
            const animal = ANIMALS[Math.floor(Math.random() * ANIMALS.length)];
            
            // Show animal
            const animalEl = document.getElementById(`animal-${holeIndex}`);
            animalEl.textContent = animal.emoji;
            animalEl.dataset.points = animal.points;
            animalEl.dataset.name = animal.name;
            animalEl.classList.add('visible');
            animalEl.classList.remove('hit');

            playSound('pop');

            // Hide animal after timeout
            hideTimer = setTimeout(() => {
                if (animalEl.classList.contains('visible') && !animalEl.classList.contains('hit')) {
                    animalEl.classList.remove('visible');
                }
                scheduleNextAnimal();
            }, GAME_CONFIG.animalVisibleTime);
        }

        // Clear all animals
        function clearAllAnimals() {
            for (let i = 0; i < GAME_CONFIG.holes; i++) {
                const animalEl = document.getElementById(`animal-${i}`);
                animalEl.classList.remove('visible', 'hit');
            }
        }

        // Handle hole click
        function handleHoleClick(e) {
            if (!gameState.isPlaying) return;

            const hole = e.currentTarget;
            const holeIndex = parseInt(hole.dataset.index);
            const animalEl = document.getElementById(`animal-${holeIndex}`);

            // Check if animal is visible and not already hit
            if (animalEl.classList.contains('visible') && !animalEl.classList.contains('hit')) {
                // Hit the animal!
                const points = parseInt(animalEl.dataset.points) || 10;
                
                // Mark as hit
                animalEl.classList.add('hit');
                
                // Update score
                gameState.score += points;
                scoreDisplay.textContent = gameState.score;

                // Show score popup
                showScorePopup(hole, points);

                // Play hit sound
                playSound('hit');

                // Clear hide timer since we hit it
                clearTimeout(hideTimer);

                // Schedule next animal after hit animation
                setTimeout(() => {
                    animalEl.classList.remove('visible', 'hit');
                    scheduleNextAnimal();
                }, 300);
            }
        }

        // Show score popup
        function showScorePopup(hole, points) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = `+${points}`;
            popup.style.left = '50%';
            popup.style.top = '30%';
            popup.style.transform = 'translateX(-50%)';
            hole.appendChild(popup);

            setTimeout(() => {
                popup.remove();
            }, 800);
        }

        // End game
        function endGame() {
            gameState.isPlaying = false;

            // Clear all timers
            clearInterval(gameTimer);
            clearTimeout(popTimer);
            clearTimeout(hideTimer);

            // Clear animals
            clearAllAnimals();

            // Play game over sound
            playSound('gameOver');

            // Check for new high score
            const isNewHighScore = gameState.score > gameState.highScore;
            
            if (isNewHighScore) {
                gameState.highScore = gameState.score;
            }

            // Save score to localStorage
            saveScore(gameState.playerName, gameState.score);

            // Update game over screen
            finalScore.textContent = gameState.score.toLocaleString();
            gameOverHighScore.textContent = gameState.highScore.toLocaleString();
            
            // Show/hide new high score message
            if (isNewHighScore && gameState.score > 0) {
                newHighScoreEl.style.display = 'block';
            } else {
                newHighScoreEl.style.display = 'none';
            }

            // Show game over screen
            gameScreen.style.display = 'none';
            gameOverScreen.style.display = 'block';
        }

        // Restart game
        function restartGame() {
            gameOverScreen.classList.add('hidden');
            startGame();
        }

        // Show main menu
        function showMainMenu() {
            // Update displays with latest data
            displayHighScore.textContent = gameState.highScore.toLocaleString();
            displayLeaderboard();
            
            // Pre-fill player name
            if (gameState.playerName) {
                playerNameInput.value = gameState.playerName;
            }

            // Show start screen
            gameScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            startScreen.classList.remove('hidden');
        }

        // Close game
        function closeGame() {
            // Try to close window or notify parent
            window.parent.postMessage({ type: 'applaa-game-close' }, '*');
            
            // Fallback: try to close window
            if (window.opener || window.parent !== window) {
                window.close();
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', init);

        // Prevent context menu on long press (mobile)
        document.addEventListener('contextmenu', (e) => e.preventDefault());

        // Handle visibility change (pause when tab hidden)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && gameState.isPlaying) {
                // Pause timers when tab is hidden
                clearInterval(gameTimer);
                clearTimeout(popTimer);
                clearTimeout(hideTimer);
            } else if (!document.hidden && gameState.isPlaying) {
                // Resume when tab is visible again
                gameTimer = setInterval(updateTimer, 1000);
                scheduleNextAnimal();
            }
        });
    </script>
</body>
</html>